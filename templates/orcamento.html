{% extends "base.html" %}
{% block title %}Orçamento{% endblock %}
{% block content %}
<style>
  .field{width:100%; padding:8px; border:1px solid #d0d0d0; border-radius:8px;}
  .label{font-weight:600; margin:8px 0 4px;}
  .muted{opacity:.75;}
  .chip{display:inline-block; padding:6px 10px; border-radius:9999px; border:1px solid #e1e1e1; margin:4px 6px 0 0; font-size:0.9rem;}
  .col{display:flex; flex-direction:column; gap:8px;}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px;}
  .total{font-size:1.2rem; font-weight:700;}
  textarea{width:100%; min-height:120px; padding:10px; border:1px solid #d0d0d0; border-radius:8px;}
</style>

<div class="grid">
  <div class="col">
    <div class="label">Visão</div>
    <select id="visao" class="field">
      <option value="longe">Longe</option>
      <option value="perto">Perto</option>
      <option value="ocupacional">Ocupacional</option>
      <option value="multifocal">Multifocal</option>
    </select>

    <div class="label">Flags</div>
    <label><input type="checkbox" id="flag_ar"> AR</label>
    <label><input type="checkbox" id="flag_foto"> Fotossensível</label>
    <label><input type="checkbox" id="flag_azul"> Filtro Azul</label>

    <div class="label">Receita OD</div>
    <div class="grid">
      <input id="od_esf" class="field" placeholder="Esférico (ex: -2,50)">
      <input id="od_cil" class="field" placeholder="Cilíndrico (ex: -0,75)">
    </div>

    <div class="label">Receita OE</div>
    <div class="grid">
      <input id="oe_esf" class="field" placeholder="Esférico (ex: -2,50)">
      <input id="oe_cil" class="field" placeholder="Cilíndrico (ex: -0,75)">
    </div>

    <button id="btn_calcular" class="field">Buscar produtos</button>

    <div class="label">Produtos disponíveis</div>
    <!-- MODO ÚNICO -->
    <select id="sel_produto_single" class="field" disabled>
      <option value="" selected disabled class="muted">Selecione um produto</option>
    </select>

    <!-- MODO DUAL -->
    <div id="box_dual" style="display:none; margin-top:8px;">
      <div style="margin-bottom:8px;">
        <div class="muted" style="margin-bottom:6px;">Produto OD</div>
        <select id="sel_produto_od" class="field" disabled>
          <option value="" selected disabled class="muted">Selecione produto para OD</option>
        </select>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px;">Produto OE</div>
        <select id="sel_produto_oe" class="field" disabled>
          <option value="" selected disabled class="muted">Selecione produto para OE</option>
        </select>
      </div>
    </div>

    <div class="label">Serviços indispensáveis</div>
    <div id="list_serv_mand"></div>

    <div class="label">Serviços adicionais</div>
    <select id="sel_serv_add" multiple class="field" disabled></select>
  </div>

  <div class="col">
    <div class="label">Resumo</div>
    <textarea id="produto_final" readonly></textarea>

    <div class="label">Total</div>
    <div class="total">R$ <span id="total_val">0,00</span></div>
  </div>
</div>

<script>
const sel_single = document.getElementById('sel_produto_single');
const box_dual   = document.getElementById('box_dual');
const sel_od     = document.getElementById('sel_produto_od');
const sel_oe     = document.getElementById('sel_produto_oe');
const list_serv_mand = document.getElementById('list_serv_mand');
const sel_serv_add = document.getElementById('sel_serv_add');
const produto_final = document.getElementById('produto_final');
const total_val = document.getElementById('total_val');

const btn = document.getElementById('btn_calcular');
const visao = document.getElementById('visao');
const flag_ar = document.getElementById('flag_ar');
const flag_foto = document.getElementById('flag_foto');
const flag_azul = document.getElementById('flag_azul');
const od_esf = document.getElementById('od_esf');
const od_cil = document.getElementById('od_cil');
const oe_esf = document.getElementById('oe_esf');
const oe_cil = document.getElementById('oe_cil');

let state = {
  same: true,
  products: [],
  productSelected: null,
  od_products: [],
  oe_products: [],
  productSelectedOD: null,
  productSelectedOE: null,
  mandatory: [],
  optional: [],
  optionalsSelected: []
};

function moneyBR(v){ return (isNaN(v)?0:v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }

function montarPayloadOrcamento(){
  return {
    visao: visao.value,
    flags: { ar: flag_ar.checked, foto: flag_foto.checked, azul: flag_azul.checked },
    od: { esf: od_esf.value, cil: od_cil.value },
    oe: { esf: oe_esf.value, cil: oe_cil.value }
  };
}

btn.addEventListener('click', tryFetchOptions);

async function tryFetchOptions(){
  const payload = montarPayloadOrcamento();
  const resp = await fetch("{{ url_for('api_orcamento_options_v3') }}", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });
  const data = await resp.json();

  state.same         = !!data.same;
  state.products     = data.products || [];
  state.od_products  = data.od_products || [];
  state.oe_products  = data.oe_products || [];
  state.productSelected   = null;
  state.productSelectedOD = null;
  state.productSelectedOE = null;
  state.mandatory = []; state.optional = []; state.optionalsSelected = [];

  if (state.same){
    sel_single.innerHTML = '<option value="" disabled selected class="muted">Selecione um produto</option>';
    state.products.forEach(p=>{
      const o=document.createElement('option');
      o.value=String(p.id);
      o.textContent=`${p.name} — R$ ${moneyBR(p.price)}`;
      o.dataset.price=p.price ?? 0;
      sel_single.appendChild(o);
    });
    sel_single.disabled = (state.products.length===0);
    sel_single.style.display='';
    box_dual.style.display='none';
    sel_od.disabled = sel_oe.disabled = true;
  } else {
    function fill(sel, arr, placeholder){
      sel.innerHTML = `<option value="" disabled selected class="muted">${placeholder}</option>`;
      arr.forEach(p=>{
        const o=document.createElement('option');
        o.value=String(p.id);
        o.textContent=`${p.name} — R$ ${moneyBR(p.price)}`;
        o.dataset.price=p.price ?? 0;
        sel.appendChild(o);
      });
      sel.disabled = (arr.length===0);
    }
    fill(sel_od, state.od_products, "Selecione produto para OD");
    fill(sel_oe, state.oe_products, "Selecione produto para OE");

    sel_single.style.display='none';
    box_dual.style.display='';
  }

  list_serv_mand.innerHTML='';
  sel_serv_add.innerHTML='';
  sel_serv_add.disabled=true;
  updateSummaryAndTotal();
}

async function loadServicesSingle(productId){
  const resp = await fetch("{{ url_for('api_orcamento_services_v3') }}", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ product_id: parseInt(productId,10) })
  });
  return await resp.json();
}

async function loadServicesDual(pidOD, pidOE){
  const resp = await fetch("{{ url_for('api_orcamento_services_v3') }}", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ product_id_od: parseInt(pidOD,10), product_id_oe: parseInt(pidOE,10) })
  });
  return await resp.json();
}

function renderServices(data){
  state.mandatory = data.mandatory||[];
  state.optional  = data.optional||[];
  state.optionalsSelected = [];

  list_serv_mand.innerHTML='';
  state.mandatory.forEach(s=>{
    const chip=document.createElement('div');
    chip.className='chip';
    chip.textContent = `${s.name} — R$ ${moneyBR(s.price||0)}`;
    list_serv_mand.appendChild(chip);
  });

  sel_serv_add.innerHTML='';
  state.optional.forEach(s=>{
    const o=document.createElement('option');
    o.value = s.id || s.code;
    o.textContent = `${s.name} — R$ ${moneyBR(s.price||0)}`;
    o.dataset.price = s.price || 0;
    sel_serv_add.appendChild(o);
  });
  sel_serv_add.disabled = state.optional.length===0;

  updateSummaryAndTotal();
}

sel_single.addEventListener('change', async ()=>{
  state.productSelected = state.products.find(p=>String(p.id)===sel_single.value)||null;
  const data = await loadServicesSingle(sel_single.value);
  renderServices(data);
});

sel_od.addEventListener('change', async ()=>{
  state.productSelectedOD = state.od_products.find(p=>String(p.id)===sel_od.value)||null;
  if (state.productSelectedOE){
    const data = await loadServicesDual(sel_od.value, sel_oe.value);
    renderServices(data);
  } else {
    list_serv_mand.innerHTML=''; sel_serv_add.innerHTML=''; sel_serv_add.disabled=true;
    updateSummaryAndTotal();
  }
});

sel_oe.addEventListener('change', async ()=>{
  state.productSelectedOE = state.oe_products.find(p=>String(p.id)===sel_oe.value)||null;
  if (state.productSelectedOD){
    const data = await loadServicesDual(sel_od.value, sel_oe.value);
    renderServices(data);
  } else {
    list_serv_mand.innerHTML=''; sel_serv_add.innerHTML=''; sel_serv_add.disabled=true;
    updateSummaryAndTotal();
  }
});

sel_serv_add.addEventListener('change', ()=>{
  state.optionalsSelected = Array.from(sel_serv_add.selectedOptions).map(o=>({
    id:o.value, price: parseFloat(o.dataset.price||'0'), name:o.textContent
  }));
  updateSummaryAndTotal();
});

function updateSummaryAndTotal(){
  const mandTotal = (state.mandatory||[]).reduce((s,x)=>s+(parseFloat(x.price)||0),0);
  const optTotal  = (state.optionalsSelected||[]).reduce((s,x)=>s+(parseFloat(x.price)||0),0);

  let produtoDesc=''; let produtoValor=0;

  if (state.same){
    if (state.productSelected){
      produtoDesc = `${state.productSelected.name} (1 par) — R$ ${moneyBR(state.productSelected.price||0)}`;
      produtoValor = parseFloat(state.productSelected.price||0);
    }
  } else {
    const pOD=state.productSelectedOD, pOE=state.productSelectedOE;
    if (pOD && pOE){
      const vOD=parseFloat(pOD.price||0), vOE=parseFloat(pOE.price||0);
      produtoDesc = `½ ${pOD.name} + ½ ${pOE.name} — R$ ${moneyBR(0.5*vOD+0.5*vOE)}`;
      produtoValor = 0.5*vOD + 0.5*vOE;
    }
  }

  const total = produtoValor + mandTotal + optTotal;

  const linhas=[];
  if (produtoDesc) linhas.push(`Produto: ${produtoDesc}`);
  if ((state.mandatory||[]).length){
    linhas.push('Serviços indispensáveis:');
    state.mandatory.forEach(s=>linhas.push(`  - ${s.name} — R$ ${moneyBR(s.price||0)}`));
  }
  if ((state.optionalsSelected||[]).length){
    linhas.push('Serviços adicionais:');
    state.optionalsSelected.forEach(s=>linhas.push(`  - ${s.name}`));
  }
  produto_final.value = linhas.join('\\n');
  total_val.textContent = moneyBR(total);
}
</script>
{% endblock %}