{% extends "base.html" %}
{% block title %}Extornos{% endblock %}
{% block content %}
<h2>Extornos → Crédito para Fornecedor</h2>

<form method="get" action="{{ url_for('extornos_index') }}" class="card" style="padding:12px; margin-bottom:12px;">
  <div style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap;">
    <div>
      <label><strong>Data do pagamento</strong></label><br>
      <input type="date" name="date" value="{{ day }}" required>
    </div>
    <div>
      <button class="btn">Filtrar</button>
    </div>
    <div class="muted">Selecione o dia em que o pagamento foi feito para listar os itens extensíveis.</div>
  </div>
</form>

<div class="card" style="padding:12px;">
  <table>
    <thead>
      <tr>
        <th>Fornecedor</th>
        <th>Produto</th>
        <th>Código</th>
        <th>Dioptria</th>
        <th>Valor (R$)</th>
        <th>OS</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
    {% for r in items %}
      {% set valor = (r.quantity or 0) * (r.unit_price or 0.0) %}
      <tr>
        <td>{{ r.supplier_name }}</td>
        <td>{{ r.product_name }}</td>
        <td>{{ r.product_code or '' }}</td>
        <td class="muted">{{ fmt_dioptria(r) }}</td>
        <td>{{ '%.2f'|format(valor) }}</td>
        <td>#{{ r.order_id }}</td>
        <td>
          {% if r.already %}
            <span class="badge" style="background:#fff3cd; color:#7a5d00;">Já extornado</span>
          {% else %}
            <form method="post" action="{{ url_for('extornos_criar', item_id=r.item_id) }}?date={{ day }}" onsubmit="return confirm('Confirmar extorno deste item?');">
              <button class="btn danger small">Extornar</button>
            </form>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    {% if items|length == 0 %}
      <tr><td colspan="7" class="muted" style="text-align:center; padding:12px;">Nenhum item pago neste dia.</td></tr>
    {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}
