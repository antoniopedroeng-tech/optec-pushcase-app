{% extends "base.html" %}
{% block title %}Novo Pedido{% endblock %}

{% block content %}
<div class="container" style="max-width: 980px; margin: 0 auto;">
  <h2>Novo Pedido</h2>

  <form method="post" id="form-novo-pedido">
    <input type="hidden" name="action" id="action" value="add">

    <!-- Ordem: OS, Meio/Par, Tipo, Produto, Fornecedor(s), Dioptrias -->
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div>
        <label><strong>OS</strong></label>
        <input type="text" name="os_number" class="form-control" required>
      </div>

      <div>
        <label><strong>Quantidade</strong></label>
        <select name="pair_option" class="form-control" id="pair_option" required>
          <option value="">— selecione —</option>
          <option value="meio">Meio par</option>
          <option value="par">Um par</option>
        </select>
      </div>

      <div>
        <label><strong>Tipo</strong></label>
        <select name="tipo" class="form-control" id="tipo" required>
          <option value="">— selecione —</option>
          <option value="lente">Lente</option>
          <option value="bloco">Bloco</option>
        </select>
      </div>

      <div>
        <label><strong>Produto</strong></label>
        <select name="product_id" class="form-control" id="product_id" required>
          <option value="">— selecione —</option>
          {% for p in products %}
            <option value="{{ p.id }}" data-kind="{{ p.kind }}">{{ p.name }} ({{ p.kind }})</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label><strong>Fornecedor (item 1)</strong></label>
        <select name="supplier_main" class="form-control" id="supplier_main" required>
          <option value="">— selecione —</option>
          <!-- preenchido via JS com base no produto -->
        </select>
      </div>

      <div>
        <label><strong>Preço (item 1)</strong></label>
        <input type="number" step="0.01" name="price_main" class="form-control" required>
      </div>
    </div>

    <div style="margin-top:12px;">
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" name="supplier_distinto" id="supplier_distinto">
        <span>Fornecedor distinto para o segundo item</span>
      </label>
    </div>

    <div id="supplier_second_wrap" style="display:none; margin-top:8px; grid-template-columns: 1fr 1fr; gap:12px;" class="grid-2">
      <div>
        <label><strong>Fornecedor (item 2)</strong></label>
        <select name="supplier_second" class="form-control" id="supplier_second">
          <option value="">— selecione —</option>
          <!-- preenchido via JS -->
        </select>
      </div>
      <div>
        <label><strong>Preço (item 2)</strong></label>
        <input type="number" step="0.01" name="price_second" class="form-control">
      </div>
    </div>

    <!-- Dioptrias -->
    <div id="dioptria_area" style="margin-top:16px;">
      <!-- LENTE -->
      <div id="diop_lente" style="display:none;">
        <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:12px;">
          <div>
            <h4>Item 1</h4>
            <label>Esférico</label>
            <input type="number" step="0.25" name="d1_sphere" class="form-control">
            <label style="margin-top:8px;">Cilíndrico</label>
            <input type="number" step="0.25" name="d1_cylinder" class="form-control">
          </div>
          <div id="diop_lente_item2" style="display:none;">
            <h4>Item 2</h4>
            <label>Esférico</label>
            <input type="number" step="0.25" name="d2_sphere" class="form-control">
            <label style="margin-top:8px;">Cilíndrico</label>
            <input type="number" step="0.25" name="d2_cylinder" class="form-control">
          </div>
        </div>
      </div>

      <!-- BLOCO -->
      <div id="diop_bloco" style="display:none;">
        <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:12px;">
          <div>
            <h4>Item 1</h4>
            <label>Base</label>
            <select name="d1_base" class="form-control">
              <option value="">—</option>
              <option>0.5</option><option>1.0</option><option>2.0</option>
              <option>4.0</option><option>6.0</option><option>8.0</option><option>10.0</option>
            </select>
            <label style="margin-top:8px;">Adição</label>
            <input type="number" step="0.25" name="d1_addition" class="form-control">
          </div>
          <div id="diop_bloco_item2" style="display:none;">
            <h4>Item 2</h4>
            <label>Base</label>
            <select name="d2_base" class="form-control">
              <option value="">—</option>
              <option>0.5</option><option>1.0</option><option>2.0</option>
              <option>4.0</option><option>6.0</option><option>8.0</option><option>10.0</option>
            </select>
            <label style="margin-top:8px;">Adição</label>
            <input type="number" step="0.25" name="d2_addition" class="form-control">
          </div>
        </div>
      </div>
    </div>

    <!-- Ações -->
    <div style="margin-top:16px; display:flex; gap:12px;">
      <button class="btn btn-primary" onclick="setAction('add')">Adicionar à Lista</button>
      <button class="btn btn-warning" onclick="setAction('clear')">Limpar Lista</button>
      <button class="btn btn-success" onclick="setAction('submit')">Enviar ao Pagador</button>
    </div>
  </form>

  <!-- Lista atual (uma linha por item/unidade) -->
  <div style="margin-top:24px;">
    <h3>Lista de envio</h3>
    {% if cart and cart|length > 0 %}
      <table class="table table-striped">
        <thead>
          <tr>
            <th>OS</th>
            <th>Produto</th>
            <th>Fornecedor</th>
            <th>Tipo</th>
            <th>Dioptria</th>
            <th style="text-align:right;">Valor (R$)</th>
          </tr>
        </thead>
        <tbody>
          {% for it in cart %}
            <tr>
              <td>{{ it.os_number }}</td>
              <td>{{ it.product_name }}</td>
              <td>{{ it.supplier_name }}</td>
              <td>{{ it.tipo }}</td>
              <td>
                {% if it.tipo == 'lente' %}
                  Esf {{ '%+.2f'|format(it.sphere) }} / Cil {{ '%+.2f'|format(it.cylinder) }}
                {% else %}
                  Base {{ '%.2f'|format(it.base) }} / Adição {{ '+%.2f'|format(it.addition) }}
                {% endif %}
              </td>
              <td style="text-align:right;">{{ '%.2f'|format(it.price) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p style="color:#666;">Nenhum item na lista.</p>
    {% endif %}
  </div>
</div>

<script>
  const combos = {{ combos|tojson }};
  const productSelect = document.getElementById('product_id');
  const supplierMain = document.getElementById('supplier_main');
  const supplierSecond = document.getElementById('supplier_second');
  const supplierDistinto = document.getElementById('supplier_distinto');
  const supplierSecondWrap = document.getElementById('supplier_second_wrap');

  const tipoSel = document.getElementById('tipo');
  const pairSel = document.getElementById('pair_option');
  const diopLente = document.getElementById('diop_lente');
  const diopLente2 = document.getElementById('diop_lente_item2');
  const diopBloco = document.getElementById('diop_bloco');
  const diopBloco2 = document.getElementById('diop_bloco_item2');

  function setAction(act){
    document.getElementById('action').value = act;
  }

  function fillSuppliersFor(productId){
    const options = combos.filter(c => c.product_id == productId);
    const makeOptions = (sel) => {
      sel.innerHTML = '<option value="">— selecione —</option>';
      options.forEach(o => {
        const op = document.createElement('option');
        op.value = o.supplier_id;
        op.textContent = `${o.supplier_name} (máx R$ ${Number(o.max_price).toFixed(2)})`;
        sel.appendChild(op);
      });
    };
    makeOptions(supplierMain);
    makeOptions(supplierSecond);
  }

  productSelect.addEventListener('change', (e)=>{
    const pid = e.target.value;
    if(pid){
      fillSuppliersFor(pid);
    }else{
      supplierMain.innerHTML = '<option value="">— selecione —</option>';
      supplierSecond.innerHTML = '<option value="">— selecione —</option>';
    }
  });

  supplierDistinto.addEventListener('change', ()=>{
    supplierSecondWrap.style.display = supplierDistinto.checked ? 'grid' : 'none';
  });

  function updateDioptriaArea(){
    const tipo = tipoSel.value;
    const pair = pairSel.value;

    diopLente.style.display = (tipo === 'lente') ? 'block' : 'none';
    diopBloco.style.display = (tipo === 'bloco') ? 'block' : 'none';

    const showSecond = (pair === 'par');
    diopLente2.style.display = showSecond ? 'block' : 'none';
    diopBloco2.style.display = showSecond ? 'block' : 'none';
  }

  tipoSel.addEventListener('change', updateDioptriaArea);
  pairSel.addEventListener('change', updateDioptriaArea);
  document.addEventListener('DOMContentLoaded', updateDioptriaArea);
</script>
{% endblock %}
