{% extends "base.html" %}
{% block title %}Novo Pedido{% endblock %}
{% block content %}
<style>
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .form-check-inline { display: inline-flex; align-items: center; gap: 8px; margin-right: 18px; }
  .form-check-inline input[type="checkbox"],
  .form-check-inline input[type="radio"] { transform: scale(1.15); margin: 0; }
  .section { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
  .actions { display:flex; gap:8px; flex-wrap: wrap; }
  table.items { width:100%; border-collapse: collapse; margin-top: 10px; }
  table.items th, table.items td { border:1px solid #ddd; padding:6px 8px; font-size: 14px; }
  table.items th { background:#f9f9f9; }
  .muted { color:#666; font-size: 12px; }
  .max-hint { font-size: 12px; color:#444; margin-top:4px }
</style>

<h2>Novo Pedido</h2>

<form id="pedidoForm" method="post">
  <!-- OS e Par/Meio -->
  <div class="section">
    <div class="form-row">
      <div>
        <label>OS</label>
        <input type="text" name="os_number" id="os_number" class="form-control" required inputmode="numeric" pattern="[0-9]*" placeholder="{{ (cfg.os_min ~ '–' ~ cfg.os_max) if (cfg is defined and cfg.os_min is not none and cfg.os_max is not none) else '' }}">
      </div>
      <div>
        <label>Par</label><br/>
        <label class="form-check-inline">
          <input type="radio" name="pair_option" value="meio" checked>
          <span>Meio par</span>
        </label>
        <label class="form-check-inline">
          <input type="radio" name="pair_option" value="par">
          <span>Um par</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Tipo, Produto (por código/nome) -->
  <div class="section">
    <div class="form-row">
      <div>
        <label>Tipo</label>
        <select name="tipo" id="tipo" class="form-control">
          <option value="lente">Lente</option>
          <option value="bloco">Bloco</option>
        </select>
      </div>

      <div>
        <label>Código do produto</label>
        <input list="codes" name="product_code" id="product_code" class="form-control" placeholder="Ex.: LA167">
        <datalist id="codes"><!-- opções preenchidas dinamicamente pelo tipo --></datalist>
        <div class="muted">Digite o código (lista filtrada pelo tipo selecionado).</div>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Produto</label>
        <select name="product_id" id="product_id" class="form-control">
          <option value="">Selecione…</option>
          {% for p in products %}
            <option value="{{p.id}}" data-code="{{p.code or ''}}" data-kind="{{p.kind}}">{{p.name}} {% if p.code %}— {{p.code}}{% endif %}</option>
          {% endfor %}
        </select>
        <div class="muted">A lista é filtrada pelo tipo.</div>
      </div>

      <div>
        <label>Fornecedor (disponíveis pela regra)</label>
        <select name="supplier_main" id="supplier_main" class="form-control"></select>
        <div class="muted">A lista é filtrada pelo produto escolhido.</div>
      </div>
    </div>
  </div>

  <!-- Dioptrias -->
  <div class="section">
    <div id="lente_fields">
      <div class="form-row">
        <div>
          <label>Esférico (A)</label>
          <input type="number" step="0.25" name="d1_sphere" class="form-control">
        </div>
        <div>
          <label>Cilíndrico (A)</label>
          <input type="number" step="0.25" name="d1_cylinder" class="form-control cil">
          <div class="muted">O sistema sempre normaliza para negativo.</div>
        </div>
      </div>

      <div id="lente_d2_wrap" style="display:none">
        <div class="form-row">
          <div>
            <label>Esférico (B)</label>
            <input type="number" step="0.25" name="d2_sphere" class="form-control">
          </div>
          <div>
            <label>Cilíndrico (B)</label>
            <input type="number" step="0.25" name="d2_cylinder" class="form-control cil">
            <div class="muted">O sistema sempre normaliza para negativo.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="bloco_fields" style="display:none">
      <div class="form-row">
        <div>
          <label>Base (A)</label>
          <select name="d1_base" class="form-control">
            <option value="">Selecione…</option>
            <option>0.5</option><option>1.0</option><option>2.0</option>
            <option>4.0</option><option>6.0</option><option>8.0</option><option>10.0</option>
          </select>
        </div>
        <div>
          <label>Adição (A)</label>
          <input type="number" step="0.25" name="d1_addition" class="form-control">
        </div>
      </div>

      <div id="bloco_d2_wrap" style="display:none">
        <div class="form-row">
          <div>
            <label>Base (B)</label>
            <select name="d2_base" class="form-control">
              <option value="">Selecione…</option>
              <option>0.5</option><option>1.0</option><option>2.0</option>
              <option>4.0</option><option>6.0</option><option>8.0</option><option>10.0</option>
            </select>
          </div>
          <div>
            <label>Adição (B)</label>
            <input type="number" step="0.25" name="d2_addition" class="form-control">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fornecedor distinto + preços -->
  <div class="section">
    <div class="form-row">
      <div>
        <label>Valor (A)</label>
        <input type="number" step="0.01" name="price_main" id="price_main" class="form-control">
        <div id="price_main_max" class="max-hint"></div>
      </div>
      <div>
        <label class="form-check-inline">
          <input type="checkbox" name="supplier_distinto" id="supplier_distinto">
          <span>Fornecedor distinto</span>
        </label>
      </div>
    </div>

    <div id="second_supplier_wrap" style="display:none">
      <div class="form-row">
        <div>
          <label>Fornecedor (B)</label>
          <select name="supplier_second" id="supplier_second" class="form-control"></select>
        </div>
        <div>
          <label>Valor (B)</label>
          <input type="number" step="0.01" name="price_second" id="price_second" class="form-control">
          <div id="price_second_max" class="max-hint"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Área de lista temporária no cliente -->
  <div class="section">
    <div class="actions">
      <button type="button" id="add_to_list" class="btn btn-secondary">Adicionar à lista</button>
      <button type="button" id="clear_list" class="btn btn-light">Limpar lista</button>
      <button type="submit" class="btn btn-primary">Enviar ao pagador</button>
    </div>
    <div class="muted">Cada linha da lista é uma unidade. Para par de lentes, serão 2 linhas (A e B).</div>

    <table class="items" id="items_table" style="display:none">
      <thead>
        <tr>
          <th>OS</th>
          <th>Tipo</th>
          <th>Produto</th>
          <th>Fornecedor</th>
          <th>Dioptria</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="5" style="text-align:right">Total</th>
          <th id="total_cell">0,00</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <input type="hidden" name="hidden_payload" id="hidden_payload">
</form>

<script>
  // --- dados vindos do backend (regras e produtos) ---
  const combos = {{ combos|tojson }};
  const productsAll = {{ products|tojson }};
  // Configuração de intervalo de OS (vindas do backend)
  const cfgOS = {{ (cfg or {}) | tojson }};

  function osDentroDoIntervalo(osStr) {
    if (!osStr || !/^\d+$/.test(osStr)) return false;
    const n = Number(osStr);
    if (cfgOS && cfgOS.os_min != null && cfgOS.os_max != null) {
      return n >= Number(cfgOS.os_min) && n <= Number(cfgOS.os_max);
    }
    return true;
  }

  function osJaNaListaCount(osStr) {
    return pendingItems.filter(it => String(it.os_number) === String(osStr)).length;
  }

  function suppliersForProduct(pid) {
    const items = combos.filter(c => c.product_id === Number(pid));
    const byId = new Map();
    items.forEach(c => byId.set(c.supplier_id, { id:c.supplier_id, name:c.supplier_name, max:c.max_price }));
    return Array.from(byId.values()).sort((a,b)=> a.name.localeCompare(b.name));
  }
  function ruleFor(pid, sid) {
    return combos.find(c => c.product_id === Number(pid) && c.supplier_id === Number(sid));
  }

  const tipoSel = document.getElementById('tipo');
  const productSelect = document.getElementById('product_id');
  const productCode = document.getElementById('product_code');
  const codesDatalist = document.getElementById('codes');
  const suppMain = document.getElementById('supplier_main');
  const suppSecond = document.getElementById('supplier_second');
  const supplierDistinto = document.getElementById('supplier_distinto');
  const secondWrap = document.getElementById('second_supplier_wrap');
  const pairRadios = document.querySelectorAll('input[name="pair_option"]');
  const priceMain = document.getElementById('price_main');
  const priceSecond = document.getElementById('price_second');
  const hintMain = document.getElementById('price_main_max');
  const hintSecond = document.getElementById('price_second_max');

  // >>> NOVO: buffer com todos os itens que serão enviados ao backend
  const pendingItems = [];

  // ---- FILTRO por TIPO: lista de produtos + datalist de códigos ----
  function refreshProductsByTipo() {
    const kind = tipoSel.value;
    // rebuild select
    productSelect.innerHTML = '<option value="">Selecione…</option>';
    productsAll
      .filter(p => p.kind === kind)
      .forEach(p => {
        const o = document.createElement('option');
        o.value = p.id;
        o.dataset.code = p.code || '';
        o.dataset.kind = p.kind;
        o.textContent = p.name + (p.code ? (' — ' + p.code) : '');
        productSelect.appendChild(o);
      });
    // rebuild datalist
    codesDatalist.innerHTML = '';
    productsAll
      .filter(p => p.kind === kind && (p.code||'').trim() !== '')
      .forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.code;
        opt.label = `${p.name} (${p.kind})`;
        codesDatalist.appendChild(opt);
      });
    // limpar fornecedores e dicas
    suppMain.innerHTML = '';
    suppSecond.innerHTML = '';
    hintMain.textContent = '';
    hintSecond.textContent = '';
    productCode.value = '';
  }

  // Preenche fornecedores de acordo com produto
  function refreshSuppliers() {
    const pid = productSelect.value;
    suppMain.innerHTML = '';
    suppSecond.innerHTML = '';
    hintMain.textContent = '';
    hintSecond.textContent = '';
    if (!pid) return;
    suppliersForProduct(pid).forEach(s => {
      const o1 = document.createElement('option');
      o1.value = s.id; o1.textContent = s.name;
      suppMain.appendChild(o1);
      const o2 = document.createElement('option');
      o2.value = s.id; o2.textContent = s.name;
      suppSecond.appendChild(o2);
    });
    updateMaxHints(); // mostra já o max do primeiro fornecedor
  }

  // Mostrar/atualizar textos de valor máximo
  function updateMaxHints() {
    const pid = productSelect.value;
    const sid1 = suppMain.value;
    const r1 = (pid && sid1) ? ruleFor(pid, sid1) : null;
    hintMain.textContent = r1 ? `Máximo (A): R$ ${Number(r1.max_price).toFixed(2)}` : '';

    const isPar = document.querySelector('input[name="pair_option"]:checked').value === 'par';
    if (isPar && supplierDistinto.checked) {
      const sid2 = suppSecond.value;
      const r2 = (pid && sid2) ? ruleFor(pid, sid2) : null;
      hintSecond.textContent = r2 ? `Máximo (B): R$ ${Number(r2.max_price).toFixed(2)}` : '';
    } else {
      hintSecond.textContent = '';
    }
  }

  productSelect.addEventListener('change', () => {
    refreshSuppliers();
  });

  suppMain.addEventListener('change', updateMaxHints);
  suppSecond && suppSecond.addEventListener('change', updateMaxHints);
  tipoSel.addEventListener('change', () => {
    normalizeAdditionInputs();
    refreshProductsByTipo();
    syncTipo();
    syncPairFields();
  });

  // Digitar o código -> selecionar produto automático (respeita tipo)
  productCode.addEventListener('change', () => {
    const code = productCode.value.trim();
    const kind = tipoSel.value;
    if (!code) return;
    const match = productsAll.find(p => (p.code || '').toUpperCase() === code.toUpperCase() && p.kind === kind);
    if (match) {
      productSelect.value = String(match.id);
      refreshSuppliers();
    }
  });

  // Mostrar/ocultar B e fornecedor B
  function syncPairFields() {
    const isPar = document.querySelector('input[name="pair_option"]:checked').value === 'par';
    document.getElementById('lente_d2_wrap').style.display = isPar ? '' : 'none';
    document.getElementById('bloco_d2_wrap').style.display = isPar ? '' : 'none';
    secondWrap.style.display = (isPar && supplierDistinto.checked) ? '' : 'none';
    updateMaxHints();
  }
  pairRadios.forEach(r => r.addEventListener('change', syncPairFields));
  supplierDistinto.addEventListener('change', syncPairFields);

  // Alternar blocos por tipo
  function syncTipo() {
    const t = tipoSel.value;
    document.getElementById('lente_fields').style.display = (t === 'lente') ? '' : 'none';
    document.getElementById('bloco_fields').style.display = (t === 'bloco') ? '' : 'none';
  }

  // Normalização: cilíndrico sempre negativo (no navegador)
  function normalizeCylinderInput(el) {
    if (!el.value) return;
    const v = parseFloat(el.value.replace(',', '.'));
    if (!isNaN(v)) el.value = (-Math.abs(v)).toFixed(2);
  }
  function bindCylinder() {
    document.querySelectorAll('input.cil').forEach(el => {
      el.addEventListener('blur', () => normalizeCylinderInput(el));
      el.addEventListener('change', () => normalizeCylinderInput(el));
    });
  }

  // Impedir SCROLL do mouse alterar inputs numéricos
  function preventWheelOnNumber() {
    const nums = document.querySelectorAll('input[type="number"]');
    nums.forEach(inp => {
      inp.addEventListener('wheel', e => { e.preventDefault(); inp.blur(); }, { passive:false });
    });
  }

  // Lista temporária (cliente)
  const table = document.getElementById('items_table');
  const tbody = table.querySelector('tbody');
  const totalCell = document.getElementById('total_cell');

  function fmt(n) { return Number(n || 0).toFixed(2).replace('.', ','); }

  function dioptriaResumo(tipo, d) {
    if (tipo === 'lente') {
      return `Esf ${Number(d.sphere).toFixed(2)} / Cil ${Number(d.cylinder).toFixed(2)}`;
    }
    return `Base ${Number(d.base).toFixed(2)} / Adição ${Number(d.addition).toFixed(2)}`;
  }

  function addRow(row) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.os}</td>
      <td>${row.tipo}</td>
      <td>${row.produto}</td>
      <td>${row.fornecedor}</td>
      <td>${dioptriaResumo(row.tipo, row.d)}</td>
      <td>R$ ${fmt(row.preco)}</td>
    `;
    tbody.appendChild(tr);
  }

  function currentProductName() {
    const opt = productSelect.selectedOptions[0];
    return opt ? opt.textContent : '';
  }
  function currentSupplierName(sel) {
    const opt = sel.selectedOptions[0];
    return opt ? opt.textContent : '';
  }

  function recomputeTotal() {
    let sum = 0;
    tbody.querySelectorAll('tr').forEach(tr => {
      const valTxt = tr.children[5].textContent.replace('R$','').trim().replace(/\./g,'').replace(',','.');
      const n = parseFloat(valTxt); if (!isNaN(n)) sum += n;
    });
    totalCell.textContent = fmt(sum);
    table.style.display = tbody.children.length ? '' : 'none';
  }

  function buildA() { // (A) mantém names d1_* para compatibilidade backend
    if (tipoSel.value === 'lente') {
      const sph = document.querySelector('input[name="d1_sphere"]').value;
      const cyl = document.querySelector('input[name="d1_cylinder"]').value;
      const v = parseFloat(cyl.replace(',', '.'));
      const cylNeg = isNaN(v) ? '' : (-Math.abs(v)).toFixed(2);
      return { sphere: parseFloat(sph), cylinder: parseFloat(cylNeg), base: null, addition: null };
    } else {
      return {
        base: parseFloat(document.querySelector('select[name="d1_base"]').value || ''),
        addition: parseFloat(document.querySelector('input[name="d1_addition"]').value || ''),
        sphere: null, cylinder: null
      };
    }
  }
  function buildB() { // (B) mantém names d2_* para compatibilidade backend
    if (tipoSel.value === 'lente') {
      const sph = document.querySelector('input[name="d2_sphere"]').value;
      const cyl = document.querySelector('input[name="d2_cylinder"]').value;
      const v = parseFloat(cyl.replace(',', '.'));
      const cylNeg = isNaN(v) ? '' : (-Math.abs(v)).toFixed(2);
      return { sphere: parseFloat(sph), cylinder: parseFloat(cylNeg), base: null, addition: null };
    } else {
      return {
        base: parseFloat(document.querySelector('select[name="d2_base"]').value || ''),
        addition: parseFloat(document.querySelector('input[name="d2_addition"]').value || ''),
        sphere: null, cylinder: null
      };
    }
  }

  // Checar preço contra a regra (produto + fornecedor) ANTES de adicionar
  function priceExceedsMax(pid, sid, price) {
    const r = ruleFor(pid, sid);
    if (!r) return true; // sem regra, considera inválido
    return Number(price) > Number(r.max_price) + 1e-9;
  }

  // >>> NOVO: função que prepara o objeto "item" para o backend (hidden_payload)
  function makeItemPayload(os, tipo, pid, sid, preco, d) {
    return {
      os_number: os,
      product_id: Number(pid),
      supplier_id: Number(sid),
      price: Number(preco),
      tipo: String(tipo),
      sphere: (d.sphere ?? null),
      cylinder: (d.cylinder ?? null),
      base: (d.base ?? null),
      addition: (d.addition ?? null)
    };
  }

  document.getElementById('add_to_list').addEventListener('click', () => {
    const os = document.getElementById('os_number').value.trim();
    if (!os) { alert('Informe a OS.'); return; }
    const pid = productSelect.value;
    if (!pid) { alert('Selecione um produto.'); return; }
    if (!suppMain.value) { alert('Selecione o fornecedor (A).'); return; }

    const preco1 = parseFloat(priceMain.value || '0');
    if (!preco1 || preco1 <= 0) { alert('Informe o valor (A).'); return; }
    if (priceExceedsMax(pid, suppMain.value, preco1)) {
      alert('Valor (A) acima do máximo permitido para este produto/fornecedor.');
      return;
    }

    const dA = buildA();

    // Adiciona A (UI + payload)
    addRow({
      os, tipo: tipoSel.value,
      produto: currentProductName(),
      fornecedor: currentSupplierName(suppMain),
      d: dA,
      preco: preco1
    });
    pendingItems.push(makeItemPayload(os, tipoSel.value, pid, suppMain.value, preco1, dA));

    // Se for par, checar (B)
    const isPar = document.querySelector('input[name="pair_option"]:checked').value === 'par';
    if (isPar) {
      let fornecedor2 = currentSupplierName(suppMain);
      let preco2 = preco1;
      let sid2 = suppMain.value;

      if (supplierDistinto.checked) {
        if (!suppSecond.value) { alert('Selecione o fornecedor (B).'); return; }
        fornecedor2 = currentSupplierName(suppSecond);
        sid2 = suppSecond.value;
        const p2 = parseFloat(priceSecond.value || '0');
        if (!p2 || p2 <= 0) { alert('Informe o valor (B).'); return; }
        if (priceExceedsMax(pid, sid2, p2)) {
          alert('Valor (B) acima do máximo permitido para este produto/fornecedor.');
          return;
        }
        preco2 = p2;
      }

      const dB = buildB();

      addRow({
        os, tipo: tipoSel.value,
        produto: currentProductName(),
        fornecedor: fornecedor2,
        d: dB,
        preco: preco2
      });
      pendingItems.push(makeItemPayload(os, tipoSel.value, pid, sid2, preco2, dB));
    }
    recomputeTotal();
    clearInputs();
  });

  document.getElementById('clear_list').addEventListener('click', () => {
    tbody.innerHTML = '';
    pendingItems.length = 0; // <<< NOVO: limpa também o buffer que é enviado ao backend
    recomputeTotal();
  });

  // >>> NOVO: no submit, mandamos TODA a lista no hidden_payload (JSON)
  document.getElementById('pedidoForm').addEventListener('submit', (ev) => {
    const hidden = document.getElementById('hidden_payload');
    if (!pendingItems.length) {
      // Sem lista, deixa o backend usar os campos individuais como fallback
      hidden.value = '[]';
      return;
    }
    hidden.value = JSON.stringify(pendingItems);
  });

  
  // === Adição 0 (BVS) para BLOCO ===
  function isBloco() {
    return (tipoSel && tipoSel.value === 'bloco');
  }
  function normalizeAdditionInputSingle(el) {
    if (!el) return;
    el.setAttribute('step', '0.25');
    if (isBloco()) {
      el.setAttribute('min', '0');
      el.setAttribute('placeholder', '0 = BVS (bloco)');
      // Se usuário colocou um valor intermediário (0 < x < 1), normaliza para 1.00
      const v = parseFloat((el.value || '').replace(',', '.'));
      if (!isNaN(v) && v > 0 && v < 1) el.value = '1';
      // Se estiver vazio, sugerimos 0 visualmente (sem forçar)
      // (Não auto-preenche para não surpreender.)
    } else {
      el.setAttribute('min', '1');
      el.setAttribute('placeholder', '+1,00 a +4,00');
      if (el.value === '0') el.value = '1';
      const v = parseFloat((el.value || '').replace(',', '.'));
      if (!isNaN(v) && v > 0 && v < 1) el.value = '1';
    }
  }
  function normalizeAdditionInputs() {
    normalizeAdditionInputSingle(document.querySelector('[name="d1_addition"]'));
    normalizeAdditionInputSingle(document.querySelector('[name="d2_addition"]'));
  }
  function bindAdditionGuards() {
    ['input','change','blur'].forEach(evt => {
      const a1 = document.querySelector('[name="d1_addition"]');
      const a2 = document.querySelector('[name="d2_addition"]');
      if (a1) a1.addEventListener(evt, () => normalizeAdditionInputSingle(a1));
      if (a2) a2.addEventListener(evt, () => normalizeAdditionInputSingle(a2));
    });
  }

  // Inicializações
  function init() {
    bindAdditionGuards();
    normalizeAdditionInputs();
    refreshProductsByTipo();
    syncTipo();
    syncPairFields();
    bindCylinder();
    preventWheelOnNumber();
    table.style.display = 'none';
  }
  init();
</script>
{% endblock %}




<script>
function clearInputs() {
  const os = document.getElementById('os_number'); if (os) os.value = '';
  const tipo = document.getElementById('tipo'); if (tipo) tipo.value = 'lente';

  const productSelect = document.getElementById('product_id');
  const productCode   = document.getElementById('product_code');
  if (productSelect) productSelect.value = '';
  if (productCode)   productCode.value   = '';

  const suppMain   = document.getElementById('supplier_main');
  const suppSecond = document.getElementById('supplier_second');
  const priceMain  = document.getElementById('price_main');
  const priceSecond= document.getElementById('price_second');
  const hintMain   = document.getElementById('price_main_max');
  const hintSecond = document.getElementById('price_second_max');
  if (suppMain)   suppMain.innerHTML   = '';
  if (suppSecond) suppSecond.innerHTML = '';
  if (priceMain)  priceMain.value  = '';
  if (priceSecond)priceSecond.value= '';
  if (hintMain)   hintMain.textContent   = '';
  if (hintSecond) hintSecond.textContent = '';

  const chkDist = document.getElementById('supplier_distinto');
  if (chkDist) chkDist.checked = false;
  const secondWrap = document.getElementById('second_supplier_wrap');
  if (secondWrap) secondWrap.style.display = 'none';

  const meio = document.querySelector('input[name="pair_option"][value="meio"]');
  if (meio) meio.checked = true;

  const namesToClear = ['d1_sphere','d1_cylinder','d2_sphere','d2_cylinder','d1_addition','d2_addition'];
  namesToClear.forEach(n => { const el = document.querySelector(`[name="${n}"]`); if (el) el.value = ''; });

  ['d1_base','d2_base'].forEach(n => {
    const el = document.querySelector(`select[name="${n}"]`);
    if (el) el.selectedIndex = 0;
  });

  if (typeof refreshProductsByTipo === 'function') refreshProductsByTipo();
  if (typeof normalizeAdditionInputs === 'function') normalizeAdditionInputs();
  if (typeof syncTipo === 'function') syncTipo();
  if (typeof syncPairFields === 'function') syncPairFields();
  if (typeof updateMaxHints === 'function') updateMaxHints();

  (os || document.querySelector('input,select,textarea'))?.focus();
}
</script>


