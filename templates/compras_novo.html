{% extends "base.html" %}
{% block title %}Novo Pedido{% endblock %}
{% block content %}
<style>
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .form-check-inline {
    display: inline-flex; align-items: center; gap: 8px; margin-right: 18px;
  }
  .form-check-inline input[type="checkbox"],
  .form-check-inline input[type="radio"] {
    transform: scale(1.15);
    margin: 0;
  }
  .section { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
  .actions { display:flex; gap:8px; flex-wrap: wrap; }
  table.items { width:100%; border-collapse: collapse; margin-top: 10px; }
  table.items th, table.items td { border:1px solid #ddd; padding:6px 8px; font-size: 14px; }
  table.items th { background:#f9f9f9; }
  .muted { color:#666; font-size: 12px; }
</style>

<h2>Novo Pedido</h2>

<form id="pedidoForm" method="post">
  <!-- OS e Par/Meio -->
  <div class="section">
    <div class="form-row">
      <div>
        <label>OS</label>
        <input type="text" name="os_number" id="os_number" class="form-control" required />
      </div>
      <div>
        <label>Par</label><br/>
        <label class="form-check-inline">
          <input type="radio" name="pair_option" value="meio" checked>
          <span>Meio par</span>
        </label>
        <label class="form-check-inline">
          <input type="radio" name="pair_option" value="par">
          <span>Um par</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Tipo, Produto (por código/nome) -->
  <div class="section">
    <div class="form-row">
      <div>
        <label>Tipo</label>
        <select name="tipo" id="tipo" class="form-control">
          <option value="lente">Lente</option>
          <option value="bloco">Bloco</option>
        </select>
      </div>

      <div>
        <label>Código do produto</label>
        <input list="codes" name="product_code" id="product_code" class="form-control" placeholder="Ex.: LA167">
        <datalist id="codes">
          {% for p in products %}
            {% if p.code %}
              <option value="{{p.code}}">{{p.name}} ({{p.kind}})</option>
            {% endif %}
          {% endfor %}
        </datalist>
        <div class="muted">Digite o código para localizar mais rápido.</div>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Produto</label>
        <select name="product_id" id="product_id" class="form-control">
          <option value="">Selecione…</option>
          {% for p in products %}
            <option value="{{p.id}}" data-code="{{p.code or ''}}" data-kind="{{p.kind}}">{{p.name}} {% if p.code %}— {{p.code}}{% endif %}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label>Fornecedor (disponíveis pela regra)</label>
        <select name="supplier_main" id="supplier_main" class="form-control"></select>
        <div class="muted">A lista é filtrada pelo produto escolhido.</div>
      </div>
    </div>
  </div>

  <!-- Dioptrias -->
  <div class="section">
    <div id="lente_fields">
      <div class="form-row">
        <div>
          <label>Esférico (D1)</label>
          <input type="number" step="0.25" name="d1_sphere" class="form-control">
        </div>
        <div>
          <label>Cilíndrico (D1)</label>
          <input type="number" step="0.25" name="d1_cylinder" class="form-control cil">
          <div class="muted">O sistema sempre normaliza para negativo.</div>
        </div>
      </div>

      <div id="lente_d2_wrap" style="display:none">
        <div class="form-row">
          <div>
            <label>Esférico (D2)</label>
            <input type="number" step="0.25" name="d2_sphere" class="form-control">
          </div>
          <div>
            <label>Cilíndrico (D2)</label>
            <input type="number" step="0.25" name="d2_cylinder" class="form-control cil">
            <div class="muted">O sistema sempre normaliza para negativo.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="bloco_fields" style="display:none">
      <div class="form-row">
        <div>
          <label>Base (D1)</label>
          <select name="d1_base" class="form-control">
            <option value="">Selecione…</option>
            <option>0.5</option><option>1.0</option><option>2.0</option>
            <option>4.0</option><option>6.0</option><option>8.0</option><option>10.0</option>
          </select>
        </div>
        <div>
          <label>Adição (D1)</label>
          <input type="number" step="0.25" name="d1_addition" class="form-control">
        </div>
      </div>

      <div id="bloco_d2_wrap" style="display:none">
        <div class="form-row">
          <div>
            <label>Base (D2)</label>
            <select name="d2_base" class="form-control">
              <option value="">Selecione…</option>
              <option>0.5</option><option>1.0</option><option>2.0</option>
              <option>4.0</option><option>6.0</option><option>8.0</option><option>10.0</option>
            </select>
          </div>
          <div>
            <label>Adição (D2)</label>
            <input type="number" step="0.25" name="d2_addition" class="form-control">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fornecedor distinto + preços -->
  <div class="section">
    <div class="form-row">
      <div>
        <label>Valor (D1)</label>
        <input type="number" step="0.01" name="price_main" id="price_main" class="form-control">
      </div>
      <div>
        <label class="form-check-inline">
          <input type="checkbox" name="supplier_distinto" id="supplier_distinto">
          <span>Fornecedor distinto</span>
        </label>
      </div>
    </div>

    <div id="second_supplier_wrap" style="display:none">
      <div class="form-row">
        <div>
          <label>Fornecedor (D2)</label>
          <select name="supplier_second" id="supplier_second" class="form-control"></select>
        </div>
        <div>
          <label>Valor (D2)</label>
          <input type="number" step="0.01" name="price_second" id="price_second" class="form-control">
        </div>
      </div>
    </div>
  </div>

  <!-- Área de lista temporária no cliente -->
  <div class="section">
    <div class="actions">
      <button type="button" id="add_to_list" class="btn btn-secondary">Adicionar à lista</button>
      <button type="button" id="clear_list" class="btn btn-light">Limpar lista</button>
      <button type="submit" class="btn btn-primary">Enviar ao pagador</button>
    </div>
    <div class="muted">Cada linha da lista é uma unidade. Para par de lentes, serão 2 linhas (D1 e D2).</div>

    <table class="items" id="items_table" style="display:none">
      <thead>
        <tr>
          <th>OS</th>
          <th>Tipo</th>
          <th>Produto</th>
          <th>Fornecedor</th>
          <th>Dioptria</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="5" style="text-align:right">Total</th>
          <th id="total_cell">0,00</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Campos invisíveis usados quando submeter de fato (mantidos por compatibilidade) -->
  <input type="hidden" name="hidden_payload" id="hidden_payload">
</form>

<script>
  // --- dados vindos do backend (regras e produtos) ---
  const combos = {{ combos|tojson }};
  const products = {{ products|tojson }};

  function suppliersForProduct(pid) {
    const items = combos.filter(c => c.product_id === Number(pid));
    const byId = new Map();
    items.forEach(c => byId.set(c.supplier_id, { id:c.supplier_id, name:c.supplier_name, max:c.max_price }));
    return Array.from(byId.values()).sort((a,b)=> a.name.localeCompare(b.name));
  }

  const productSelect = document.getElementById('product_id');
  const productCode = document.getElementById('product_code');
  const tipoSel = document.getElementById('tipo');
  const suppMain = document.getElementById('supplier_main');
  const suppSecond = document.getElementById('supplier_second');
  const supplierDistinto = document.getElementById('supplier_distinto');
  const secondWrap = document.getElementById('second_supplier_wrap');
  const pairRadios = document.querySelectorAll('input[name="pair_option"]');

  function refreshSuppliers() {
    const pid = productSelect.value;
    suppMain.innerHTML = '';
    suppSecond.innerHTML = '';
    if (!pid) return;
    suppliersForProduct(pid).forEach(s => {
      const o1 = document.createElement('option');
      o1.value = s.id; o1.textContent = s.name;
      suppMain.appendChild(o1);
      const o2 = document.createElement('option');
      o2.value = s.id; o2.textContent = s.name;
      suppSecond.appendChild(o2);
    });
  }

  productSelect.addEventListener('change', () => {
    const opt = productSelect.selectedOptions[0];
    if (opt && opt.dataset.kind) {
      tipoSel.value = opt.dataset.kind;
    }
    refreshSuppliers();
  });

  // Digitar o código -> selecionar produto automático (respeita tipo)
  productCode.addEventListener('change', () => {
    const code = productCode.value.trim();
    const kind = tipoSel.value;
    if (!code) return;
    const match = products.find(p => (p.code || '').toUpperCase() === code.toUpperCase() && p.kind === kind);
    if (match) {
      productSelect.value = String(match.id);
      refreshSuppliers();
    }
  });

  // Mostrar/ocultar D2 e fornecedor D2
  function syncPairFields() {
    const isPar = document.querySelector('input[name="pair_option"]:checked').value === 'par';
    document.getElementById('lente_d2_wrap').style.display = isPar ? '' : 'none';
    document.getElementById('bloco_d2_wrap').style.display = isPar ? '' : 'none';
    secondWrap.style.display = (isPar && supplierDistinto.checked) ? '' : 'none';
  }
  pairRadios.forEach(r => r.addEventListener('change', syncPairFields));
  supplierDistinto.addEventListener('change', syncPairFields);

  // Alternar blocos por tipo
  function syncTipo() {
    const t = tipoSel.value;
    document.getElementById('lente_fields').style.display = (t === 'lente') ? '' : 'none';
    document.getElementById('bloco_fields').style.display = (t === 'bloco') ? '' : 'none';
  }
  tipoSel.addEventListener('change', syncTipo);

  // Normalização: cilíndrico sempre negativo (no navegador)
  function normalizeCylinderInput(el) {
    if (!el.value) return;
    const v = parseFloat(el.value.replace(',', '.'));
    if (!isNaN(v)) el.value = (-Math.abs(v)).toFixed(2);
  }
  document.querySelectorAll('input.cil').forEach(el => {
    el.addEventListener('blur', () => normalizeCylinderInput(el));
    el.addEventListener('change', () => normalizeCylinderInput(el));
  });

  // Lista temporária (cliente)
  const table = document.getElementById('items_table');
  const tbody = table.querySelector('tbody');
  const totalCell = document.getElementById('total_cell');

  function fmt(n) { return Number(n || 0).toFixed(2).replace('.', ','); }

  function dioptriaResumo(tipo, d) {
    if (tipo === 'lente') {
      return `Esf ${Number(d.sphere).toFixed(2)} / Cil ${Number(d.cylinder).toFixed(2)}`;
    }
    return `Base ${Number(d.base).toFixed(2)} / Adição ${Number(d.addition).toFixed(2)}`;
  }

  function addRow(row) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.os}</td>
      <td>${row.tipo}</td>
      <td>${row.produto}</td>
      <td>${row.fornecedor}</td>
      <td>${dioptriaResumo(row.tipo, row.d)}</td>
      <td>R$ ${fmt(row.preco)}</td>
    `;
    tbody.appendChild(tr);
  }

  function currentProductName() {
    const opt = productSelect.selectedOptions[0];
    return opt ? opt.textContent : '';
  }
  function currentSupplierName(sel) {
    const opt = sel.selectedOptions[0];
    return opt ? opt.textContent : '';
  }

  function recomputeTotal() {
    let sum = 0;
    tbody.querySelectorAll('tr').forEach(tr => {
      const valTxt = tr.children[5].textContent.replace('R$','').trim().replace(/\./g,'').replace(',','.');
      const n = parseFloat(valTxt); if (!isNaN(n)) sum += n;
    });
    totalCell.textContent = fmt(sum);
    table.style.display = tbody.children.length ? '' : 'none';
  }

  function buildD1() {
    if (tipoSel.value === 'lente') {
      const sph = document.querySelector('input[name="d1_sphere"]').value;
      const cyl = document.querySelector('input[name="d1_cylinder"]').value;
      const v = parseFloat(cyl.replace(',', '.'));
      const cylNeg = isNaN(v) ? '' : (-Math.abs(v)).toFixed(2);
      return { sphere: parseFloat(sph), cylinder: parseFloat(cylNeg), base: null, addition: null };
    } else {
      return {
        base: parseFloat(document.querySelector('select[name="d1_base"]').value || ''),
        addition: parseFloat(document.querySelector('input[name="d1_addition"]').value || ''),
        sphere: null, cylinder: null
      };
    }
  }
  function buildD2() {
    if (tipoSel.value === 'lente') {
      const sph = document.querySelector('input[name="d2_sphere"]').value;
      const cyl = document.querySelector('input[name="d2_cylinder"]').value;
      const v = parseFloat(cyl.replace(',', '.'));
      const cylNeg = isNaN(v) ? '' : (-Math.abs(v)).toFixed(2);
      return { sphere: parseFloat(sph), cylinder: parseFloat(cylNeg), base: null, addition: null };
    } else {
      return {
        base: parseFloat(document.querySelector('select[name="d2_base"]').value || ''),
        addition: parseFloat(document.querySelector('input[name="d2_addition"]').value || ''),
        sphere: null, cylinder: null
      };
    }
  }

  document.getElementById('add_to_list').addEventListener('click', () => {
    const os = document.getElementById('os_number').value.trim();
    if (!os) { alert('Informe a OS.'); return; }
    const pid = productSelect.value;
    if (!pid) { alert('Selecione um produto.'); return; }
    if (!suppMain.value) { alert('Selecione o fornecedor (D1).'); return; }
    const preco1 = parseFloat(document.getElementById('price_main').value || '0');
    if (!preco1 || preco1 <= 0) { alert('Informe o valor (D1).'); return; }

    // Adiciona D1
    addRow({
      os, tipo: tipoSel.value,
      produto: currentProductName(),
      fornecedor: currentSupplierName(suppMain),
      d: buildD1(),
      preco: preco1
    });

    // Se for par
    const isPar = document.querySelector('input[name="pair_option"]:checked').value === 'par';
    if (isPar) {
      let fornecedor2 = currentSupplierName(suppMain);
      let preco2 = preco1;
      if (supplierDistinto.checked) {
        if (!suppSecond.value) { alert('Selecione o fornecedor (D2).'); return; }
        fornecedor2 = currentSupplierName(suppSecond);
        const p2 = parseFloat(document.getElementById('price_second').value || '0');
        if (!p2 || p2 <= 0) { alert('Informe o valor (D2).'); return; }
        preco2 = p2;
      }
      addRow({
        os, tipo: tipoSel.value,
        produto: currentProductName(),
        fornecedor: fornecedor2,
        d: buildD2(),
        preco: preco2
      });
    }
    recomputeTotal();
  });

  document.getElementById('clear_list').addEventListener('click', () => {
    tbody.innerHTML = '';
    recomputeTotal();
  });

  document.getElementById('pedidoForm').addEventListener('submit', () => {
    // Submissão padrão — backend valida e grava
  });

  // Inicializações
  function init() {
    syncTipo();
    syncPairFields();
    table.style.display = 'none';
  }
  init();
</script>
{% endblock %}
