{% extends "base.html" %}
{% block title %}Novo Pedido{% endblock %}
{% block content %}
<h2>Comprador → Novo Pedido</h2>

<form id="novoPedidoForm" method="post" action="{{ url_for('compras_novo') }}" style="display:grid;gap:12px;max-width:920px">
  <div style="display:flex;gap:12px;flex-wrap:wrap;">
    <div>
      <label><strong>Nº OS</strong></label><br>
      <input type="text" name="os_number" required>
    </div>

    <div>
      <label><strong>Quantidade</strong></label><br>
      <label><input type="radio" name="pair_option" value="meio"> Meio par</label>
      <label style="margin-left:8px;"><input type="radio" name="pair_option" value="par" checked> Par</label>
    </div>

    <div>
      <label><strong>Tipo</strong></label><br>
      <label><input type="radio" name="tipo" value="lente" checked> Lente</label>
      <label style="margin-left:8px;"><input type="radio" name="tipo" value="bloco"> Bloco</label>
    </div>
  </div>

  <div style="display:flex;gap:12px;flex-wrap:wrap;">
    <div style="min-width:280px;">
      <label><strong>Produto</strong></label><br>
      <select name="product_id" id="product_id" required>
        <option value="" selected disabled>— selecione —</option>
        {% for p in products %}
          <option value="{{ p.id }}">{{ p.name }} {% if p.code %} ({{ p.code }}){% endif %} — {{ p.kind }}</option>
        {% endfor %}
      </select>
      <div style="font-size:12px;color:#777">Opcional: informar código se preferir</div>
    </div>
    <div>
      <label><strong>Código (opcional)</strong></label><br>
      <input type="text" name="product_code" placeholder="Ex.: LA167">
    </div>
  </div>

  <fieldset style="border:1px solid #ddd;padding:12px;border-radius:8px;">
    <legend style="padding:0 6px;">Item 1</legend>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
      <div id="lente1" style="display:block;">
        <label><strong>Esférico (−20 a +20 | passo 0,25)</strong></label><br>
        <input type="number" step="0.25" name="d1_sphere" placeholder="+0.00" style="width:120px">
        <br>
        <label style="margin-top:6px;"><strong>Cilíndrico (0 a −15 | passo 0,25)</strong></label><br>
        <input type="number" step="0.25" name="d1_cylinder" placeholder="−0.00" style="width:120px">
      </div>

      <div id="bloco1" style="display:none;">
        <label><strong>Base</strong></label><br>
        <select name="d1_base" style="width:120px">
          <option value="">—</option>
          <option>0.5</option><option>1.0</option><option>2.0</option>
          <option>4.0</option><option>6.0</option><option>8.0</option><option>10.0</option>
        </select>
        <br>
        <label style="margin-top:6px;"><strong>Adição (+1,00 a +4,00 | passo 0,25)</strong></label><br>
        <input type="number" step="0.25" name="d1_addition" placeholder="+1.00" style="width:120px">
      </div>

      <div style="min-width:240px;">
        <label><strong>Fornecedor (item 1)</strong></label><br>
        <select name="supplier_main" id="supplier_main" required>
          <option value="" selected disabled>— selecione —</option>
        </select>
        <div id="max1" style="font-size:12px;color:#777;"></div>
      </div>

      <div>
        <label><strong>Preço item 1 (R$)</strong></label><br>
        <input type="number" name="price_main" id="price_main" step="0.01" min="0" required style="width:140px">
      </div>
    </div>
  </fieldset>

  <fieldset style="border:1px solid #ddd;padding:12px;border-radius:8px;">
    <legend style="padding:0 6px;">Item 2 (opcional)</legend>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
      <div>
        <label><input type="checkbox" id="supplier_distinto" name="supplier_distinto"> Fornecedor/Preço distintos do item 1</label>
      </div>

      <div id="lente2" style="display:block;">
        <label><strong>Esférico</strong></label><br>
        <input type="number" step="0.25" name="d2_sphere" placeholder="+0.00" style="width:120px">
        <br>
        <label style="margin-top:6px;"><strong>Cilíndrico</strong></label><br>
        <input type="number" step="0.25" name="d2_cylinder" placeholder="−0.00" style="width:120px">
      </div>

      <div id="bloco2" style="display:none;">
        <label><strong>Base</strong></label><br>
        <select name="d2_base" style="width:120px">
          <option value="">—</option>
          <option>0.5</option><option>1.0</option><option>2.0</option>
          <option>4.0</option><option>6.0</option><option>8.0</option><option>10.0</option>
        </select>
        <br>
        <label style="margin-top:6px;"><strong>Adição</strong></label><br>
        <input type="number" step="0.25" name="d2_addition" placeholder="+1.00" style="width:120px">
      </div>

      <div style="min-width:240px;">
        <label><strong>Fornecedor (item 2)</strong></label><br>
        <select name="supplier_second" id="supplier_second" disabled>
          <option value="" selected disabled>— selecione —</option>
        </select>
        <div id="max2" style="font-size:12px;color:#777;"></div>
      </div>

      <div>
        <label><strong>Preço item 2 (R$)</strong></label><br>
        <input type="number" name="price_second" id="price_second" step="0.01" min="0" disabled style="width:140px">
      </div>
    </div>
  </fieldset>

  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <button type="submit" name="action" value="add" class="btn">Adicionar à lista</button>
    <button type="submit" name="action" value="finalize" class="btn primary">Finalizar e Enviar</button>
  </div>
</form>

<script>
  // Dados vindos do servidor
  const COMBOS = {{ combos|tojson }};
  const PRODUCTS = {{ products|tojson }};

  const elTipoLente = () => document.querySelector('input[name="tipo"][value="lente"]').checked;
  const elPairPar = () => document.querySelector('input[name="pair_option"][value="par"]').checked;

  const productSel = document.getElementById('product_id');
  const supplierMainSel = document.getElementById('supplier_main');
  const supplierSecondSel = document.getElementById('supplier_second');
  const supplierDistinto = document.getElementById('supplier_distinto');
  const priceSecond = document.getElementById('price_second');
  const max1 = document.getElementById('max1');
  const max2 = document.getElementById('max2');

  function suppliersForProduct(pid){
    const map = new Map();
    COMBOS.filter(c => c.product_id === Number(pid))
          .forEach(c => map.set(c.supplier_id, {name: c.supplier_name, max_price: c.max_price}));
    return [...map.entries()].map(([id, v]) => ({id, name: v.name, max_price: v.max_price}));
  }

  function fillSuppliers(){
    const pid = productSel.value;
    supplierMainSel.innerHTML = '<option value="" disabled selected>— selecione —</option>';
    supplierSecondSel.innerHTML = '<option value="" disabled selected>— selecione —</option>';
    max1.textContent = ''; max2.textContent = '';

    if(!pid) return;
    const sup = suppliersForProduct(pid);
    sup.forEach(s => {
      const o1 = document.createElement('option');
      o1.value = s.id; o1.textContent = `${s.name}`;
      supplierMainSel.appendChild(o1);
      const o2 = document.createElement('option');
      o2.value = s.id; o2.textContent = `${s.name}`;
      supplierSecondSel.appendChild(o2);
    });
  }

  function showMaxPrice(selectEl, targetInfo){
    const pid = Number(productSel.value);
    const sid = Number(selectEl.value);
    if(!pid || !sid){ targetInfo.textContent = ''; return; }
    const found = COMBOS.find(c => c.product_id === pid && c.supplier_id === sid);
    targetInfo.textContent = found ? `Preço máx. permitido: R$ ${Number(found.max_price).toFixed(2)}` : '';
  }

  function toggleTipo(){
    const lente = elTipoLente();
    document.getElementById('lente1').style.display = lente ? 'block':'none';
    document.getElementById('lente2').style.display = lente ? 'block':'none';
    document.getElementById('bloco1').style.display = lente ? 'none':'block';
    document.getElementById('bloco2').style.display = lente ? 'none':'block';
  }

  function toggleSupplierSecond(){
    const enable = supplierDistinto.checked && elPairPar();
    supplierSecondSel.disabled = !enable;
    priceSecond.disabled = !enable;
    if(!enable){
      supplierSecondSel.value = '';
      priceSecond.value = '';
      max2.textContent = '';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    fillSuppliers();
    toggleTipo();
    toggleSupplierSecond();

    productSel.addEventListener('change', () => { fillSuppliers(); });

    document.querySelectorAll('input[name="tipo"]').forEach(r => r.addEventListener('change', toggleTipo));
    document.querySelectorAll('input[name="pair_option"]').forEach(r => r.addEventListener('change', toggleSupplierSecond));
    supplierDistinto.addEventListener('change', toggleSupplierSecond);

    supplierMainSel.addEventListener('change', () => showMaxPrice(supplierMainSel, max1));
    supplierSecondSel.addEventListener('change', () => showMaxPrice(supplierSecondSel, max2));

    // Limpa imediatamente ao clicar "Adicionar à lista" (feedback instantâneo).
    const form = document.getElementById('novoPedidoForm');
    form.addEventListener('submit', (ev) => {
      const btn = ev.submitter;
      if (!btn) return;
      const isAdd = (btn.name === 'action') && ['add','adicionar','add_to_list'].includes((btn.value||'').toLowerCase());
      if (isAdd) {
        setTimeout(() => { form.reset(); fillSuppliers(); toggleTipo(); toggleSupplierSecond(); }, 0);
      }
    });
  });
</script>
{% endblock %}
