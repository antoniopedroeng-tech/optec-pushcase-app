{% extends "base.html" %}
{% block title %}Novo Pedido{% endblock %}
{% block content %}
<style>
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .form-check-inline { display: inline-flex; align-items: center; gap: 8px; margin-right: 18px; }
  .form-check-inline input[type="checkbox"],
  .form-check-inline input[type="radio"] { transform: scale(1.15); margin: 0; }
  .section { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
  .actions { display:flex; gap:8px; flex-wrap: wrap; }
  table.items { width:100%; border-collapse: collapse; margin-top: 10px; }
  table.items th, table.items td { border:1px solid #ddd; padding:6px 8px; font-size: 14px; }
  table.items th { background:#f9f9f9; }
  .muted { color:#666; font-size: 12px; }
  /* remove setas do number em alguns browsers */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number] { -moz-appearance: textfield; }
</style>

<h2>Novo Pedido</h2>

<form id="pedidoForm" method="post">
  <!-- OS e Par/Meio -->
  <div class="section">
    <div class="form-row">
      <div>
        <label>OS</label>
        <input type="text" name="os_number" id="os_number" class="form-control" required />
      </div>
      <div>
        <label>Par</label><br/>
        <label class="form-check-inline">
          <input type="radio" name="pair_option" value="meio" checked>
          <span>Meio par</span>
        </label>
        <label class="form-check-inline">
          <input type="radio" name="pair_option" value="par">
          <span>Um par</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Tipo, Produto (por código/nome) -->
  <div class="section">
    <div class="form-row">
      <div>
        <label>Tipo</label>
        <select name="tipo" id="tipo" class="form-control">
          <option value="lente">Lente</option>
          <option value="bloco">Bloco</option>
        </select>
      </div>

      <div>
        <label>Código do produto</label>
        <input list="codes" name="product_code" id="product_code" class="form-control" placeholder="Ex.: LA167">
        <datalist id="codes"></datalist>
        <div class="muted">Digite o código (lista filtrada pelo tipo).</div>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Produto</label>
        <select name="product_id" id="product_id" class="form-control">
          <option value="">Selecione…</option>
          {% for p in products %}
            <option value="{{p.id}}" data-code="{{p.code or ''}}" data-kind="{{p.kind}}">{{p.name}}{% if p.code %} — {{p.code}}{% endif %}</option>
          {% endfor %}
        </select>
        <div class="muted">Máximo permitido (por fornecedor): <span id="max_info">—</span></div>
      </div>

      <div>
        <label>Fornecedor (pela regra)</label>
        <select name="supplier_main" id="supplier_main" class="form-control"></select>
        <div class="muted">Filtrado pelo produto. Cada opção mostra o máximo.</div>
      </div>
    </div>
  </div>

  <!-- Dioptrias A/B -->
  <div class="section">
    <div id="lente_fields">
      <div class="form-row">
        <div>
          <label>Esférico (A)</label>
          <input type="number" step="0.25" name="a_sphere" class="form-control num">
        </div>
        <div>
          <label>Cilíndrico (A)</label>
          <input type="number" step="0.25" name="a_cylinder" class="form-control num cil">
          <div class="muted">Normalizado para negativo.</div>
        </div>
      </div>

      <div id="lente_b_wrap" style="display:none">
        <div class="form-row">
          <div>
            <label>Esférico (B)</label>
            <input type="number" step="0.25" name="b_sphere" class="form-control num">
          </div>
          <div>
            <label>Cilíndrico (B)</label>
            <input type="number" step="0.25" name="b_cylinder" class="form-control num cil">
            <div class="muted">Normalizado para negativo.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="bloco_fields" style="display:none">
      <div class="form-row">
        <div>
          <label>Base (A)</label>
          <select name="a_base" class="form-control">
            <option value="">Selecione…</option>
            <option>0.5</option><option>1.0</option><option>2.0</option>
            <option>4.0</option><option>6.0</option><option>8.0</option><option>10.0</option>
          </select>
        </div>
        <div>
          <label>Adição (A)</label>
          <input type="number" step="0.25" name="a_addition" class="form-control num">
        </div>
      </div>

      <div id="bloco_b_wrap" style="display:none">
        <div class="form-row">
          <div>
            <label>Base (B)</label>
            <select name="b_base" class="form-control">
              <option value="">Selecione…</option>
              <option>0.5</option><option>1.0</option><option>2.0</option>
              <option>4.0</option><option>6.0</option><option>8.0</option><option>10.0</option>
            </select>
          </div>
          <div>
            <label>Adição (B)</label>
            <input type="number" step="0.25" name="b_addition" class="form-control num">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fornecedor distinto + preços -->
  <div class="section">
    <div class="form-row">
      <div>
        <label>Valor (A)</label>
        <input type="number" step="0.01" name="price_main" id="price_main" class="form-control num">
        <div class="muted">Máx A: <span id="max_main">—</span></div>
      </div>
      <div>
        <label class="form-check-inline">
          <input type="checkbox" name="supplier_distinto" id="supplier_distinto">
          <span>Fornecedor distinto para B</span>
        </label>
      </div>
    </div>

    <div id="second_supplier_wrap" style="display:none">
      <div class="form-row">
        <div>
          <label>Fornecedor (B)</label>
          <select name="supplier_second" id="supplier_second" class="form-control"></select>
        </div>
        <div>
          <label>Valor (B)</label>
          <input type="number" step="0.01" name="price_second" id="price_second" class="form-control num">
          <div class="muted">Máx B: <span id="max_second">—</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista -->
  <div class="section">
    <div class="actions">
      <button type="button" id="add_to_list" class="btn btn-secondary">Adicionar à lista</button>
      <button type="button" id="clear_list" class="btn btn-light">Limpar lista</button>
      <button type="submit" class="btn btn-primary">Enviar ao pagador</button>
    </div>
    <div class="muted">Cada linha é uma unidade. Para par, serão 2 linhas (A e B).</div>

    <table class="items" id="items_table" style="display:none">
      <thead>
        <tr>
          <th>OS</th>
          <th>Tipo</th>
          <th>Produto</th>
          <th>Fornecedor</th>
          <th>Dioptria</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="5" style="text-align:right">Total</th>
          <th id="total_cell">0,00</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <input type="hidden" name="hidden_payload" id="hidden_payload">
</form>

<script>
  const combos = {{ combos|tojson }};
  const products = {{ products|tojson }};

  // util: mapa produto -> fornecedores [{id,name,max}]
  function suppliersForProduct(pid) {
    const items = combos.filter(c => c.product_id === Number(pid));
    const byId = new Map();
    items.forEach(c => byId.set(c.supplier_id, { id:c.supplier_id, name:c.supplier_name, max:c.max_price }));
    return Array.from(byId.values()).sort((a,b)=> a.name.localeCompare(b.name));
  }

  const productSelect = document.getElementById('product_id');
  const productCode = document.getElementById('product_code');
  const codesDatalist = document.getElementById('codes');
  const tipoSel = document.getElementById('tipo');
  const suppMain = document.getElementById('supplier_main');
  const suppSecond = document.getElementById('supplier_second');
  const supplierDistinto = document.getElementById('supplier_distinto');
  const secondWrap = document.getElementById('second_supplier_wrap');
  const pairRadios = document.querySelectorAll('input[name="pair_option"]');
  const maxInfo = document.getElementById('max_info');
  const maxMain = document.getElementById('max_main');
  const maxSecond = document.getElementById('max_second');

  // rebuild datalist de códigos filtrando por tipo
  function rebuildCodeDatalist() {
    const kind = tipoSel.value;
    codesDatalist.innerHTML = '';
    products.filter(p => p.kind === kind && (p.code || '').trim() !== '')
      .forEach(p => {
        const op = document.createElement('option');
        op.value = p.code;
        op.label = `${p.name} (${p.kind})`;
        codesDatalist.appendChild(op);
      });
  }

  function refreshSuppliers() {
    const pid = productSelect.value;
    suppMain.innerHTML = '';
    suppSecond.innerHTML = '';
    maxInfo.textContent = '—';
    maxMain.textContent = '—';
    maxSecond.textContent = '—';
    if (!pid) return;
    const sup = suppliersForProduct(pid);
    sup.forEach(s => {
      const o1 = document.createElement('option');
      o1.value = s.id; o1.textContent = `${s.name} (máx R$ ${Number(s.max).toFixed(2)})`;
      o1.dataset.max = s.max;
      suppMain.appendChild(o1);
      const o2 = document.createElement('option');
      o2.value = s.id; o2.textContent = `${s.name} (máx R$ ${Number(s.max).toFixed(2)})`;
      o2.dataset.max = s.max;
      suppSecond.appendChild(o2);
    });
    // mostrar resumo de máximos disponíveis para o produto
    if (sup.length) {
      const parts = sup.map(s => `${s.name}: R$ ${Number(s.max).toFixed(2)}`);
      maxInfo.textContent = parts.join(' | ');
      updateMaxSpans();
    }
  }

  function getSelectedMax(sel) {
    const opt = sel.selectedOptions[0];
    return opt ? parseFloat(opt.dataset.max) : NaN;
  }
  function updateMaxSpans() {
    const m1 = getSelectedMax(suppMain);
    if (!isNaN(m1)) maxMain.textContent = `R$ ${m1.toFixed(2)}`;
    if (supplierDistinto.checked) {
      const m2 = getSelectedMax(suppSecond);
      if (!isNaN(m2)) maxSecond.textContent = `R$ ${m2.toFixed(2)}`;
    } else {
      maxSecond.textContent = `R$ ${(!isNaN(m1) ? m1.toFixed(2) : '--')}`;
    }
  }

  productSelect.addEventListener('change', () => {
    const opt = productSelect.selectedOptions[0];
    if (opt && opt.dataset.kind) {
      tipoSel.value = opt.dataset.kind;
      rebuildCodeDatalist();
    }
    refreshSuppliers();
  });

  // Digitar código -> selecionar produto do mesmo tipo
  productCode.addEventListener('change', () => {
    const code = productCode.value.trim();
    const kind = tipoSel.value;
    if (!code) return;
    const match = products.find(p => (p.code || '').toUpperCase() === code.toUpperCase() && p.kind === kind);
    if (match) {
      productSelect.value = String(match.id);
      refreshSuppliers();
    }
  });

  // Reagir a mudanças que afetam máximos
  suppMain.addEventListener('change', updateMaxSpans);
  suppSecond.addEventListener('change', updateMaxSpans);

  function syncPairFields() {
    const isPar = document.querySelector('input[name="pair_option"]:checked').value === 'par';
    document.getElementById('lente_b_wrap').style.display = isPar ? '' : 'none';
    document.getElementById('bloco_b_wrap').style.display = isPar ? '' : 'none';
    secondWrap.style.display = (isPar && supplierDistinto.checked) ? '' : 'none';
  }
  pairRadios.forEach(r => r.addEventListener('change', syncPairFields));
  supplierDistinto.addEventListener('change', () => { syncPairFields(); updateMaxSpans(); });

  function syncTipo() {
    const t = tipoSel.value;
    document.getElementById('lente_fields').style.display = (t === 'lente') ? '' : 'none';
    document.getElementById('bloco_fields').style.display = (t === 'bloco') ? '' : 'none';
    // filtra selects de produto visualmente
    for (const op of productSelect.options) {
      if (!op.value) continue;
      op.hidden = (op.dataset.kind !== t);
    }
    // limpar seleção incompatível
    if (productSelect.selectedOptions[0] && productSelect.selectedOptions[0].dataset.kind !== t) {
      productSelect.value = '';
    }
    rebuildCodeDatalist();
    refreshSuppliers();
  }
  tipoSel.addEventListener('change', syncTipo);

  // Normalização: cilíndrico sempre negativo
  function normalizeCylinderInput(el) {
    if (!el.value) return;
    const v = parseFloat(String(el.value).replace(',', '.'));
    if (!isNaN(v)) el.value = (-Math.abs(v)).toFixed(2);
  }
  document.querySelectorAll('input.cil').forEach(el => {
    el.addEventListener('blur', () => normalizeCylinderInput(el));
    el.addEventListener('change', () => normalizeCylinderInput(el));
  });

  // BLOQUEAR SCROLL do mouse em inputs numéricos
  function disableWheelOnNumberInputs() {
    document.querySelectorAll('input.num').forEach(inp => {
      inp.addEventListener('wheel', function(e){ this.blur(); e.preventDefault(); }, { passive:false });
    });
  }

  // Lista temporária
  const table = document.getElementById('items_table');
  const tbody = table.querySelector('tbody');
  const totalCell = document.getElementById('total_cell');

  function fmt(n) { return Number(n || 0).toFixed(2).replace('.', ','); }

  function dioptriaResumo(tipo, d) {
    if (tipo === 'lente') {
      return `Esf ${Number(d.sphere).toFixed(2)} / Cil ${Number(d.cylinder).toFixed(2)}`;
    }
    return `Base ${Number(d.base).toFixed(2)} / Adição ${Number(d.addition).toFixed(2)}`;
  }

  function addRow(row) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.os}</td>
      <td>${row.tipo.toUpperCase()} (${row.slot})</td>
      <td>${row.produto}</td>
      <td>${row.fornecedor}</td>
      <td>${dioptriaResumo(row.tipo, row.d)}</td>
      <td>R$ ${fmt(row.preco)}</td>
    `;
    tbody.appendChild(tr);
  }

  function currentProductName() {
    const opt = productSelect.selectedOptions[0];
    return opt ? opt.textContent : '';
  }
  function currentSupplierName(sel) {
    const opt = sel.selectedOptions[0];
    return opt ? opt.textContent : '';
  }

  function recomputeTotal() {
    let sum = 0;
    tbody.querySelectorAll('tr').forEach(tr => {
      const valTxt = tr.children[5].textContent.replace('R$','').trim().replace(/\./g,'').replace(',','.');
      const n = parseFloat(valTxt); if (!isNaN(n)) sum += n;
    });
    totalCell.textContent = fmt(sum);
    table.style.display = tbody.children.length ? '' : 'none';
  }

  function buildA(tipo) {
    if (tipo === 'lente') {
      const sph = document.querySelector('input[name="a_sphere"]').value;
      const cyl = document.querySelector('input[name="a_cylinder"]').value;
      const v = parseFloat((cyl || '').toString().replace(',', '.'));
      const cylNeg = isNaN(v) ? '' : (-Math.abs(v)).toFixed(2);
      return { sphere: parseFloat(sph), cylinder: parseFloat(cylNeg), base: null, addition: null };
    } else {
      return {
        base: parseFloat(document.querySelector('select[name="a_base"]').value || ''),
        addition: parseFloat(document.querySelector('input[name="a_addition"]').value || ''),
        sphere: null, cylinder: null
      };
    }
  }
  function buildB(tipo) {
    if (tipo === 'lente') {
      const sph = document.querySelector('input[name="b_sphere"]').value;
      const cyl = document.querySelector('input[name="b_cylinder"]').value;
      const v = parseFloat((cyl || '').toString().replace(',', '.'));
      const cylNeg = isNaN(v) ? '' : (-Math.abs(v)).toFixed(2);
      return { sphere: parseFloat(sph), cylinder: parseFloat(cylNeg), base: null, addition: null };
    } else {
      return {
        base: parseFloat(document.querySelector('select[name="b_base"]').value || ''),
        addition: parseFloat(document.querySelector('input[name="b_addition"]').value || ''),
        sphere: null, cylinder: null
      };
    }
  }

  // valida preço contra máximo selecionado
  function priceOk(price, max) {
    return typeof price === 'number' && !isNaN(price) && price > 0 && price <= max + 1e-6;
  }

  document.getElementById('add_to_list').addEventListener('click', () => {
    const os = document.getElementById('os_number').value.trim();
    if (!os) { alert('Informe a OS.'); return; }
    const pid = productSelect.value;
    if (!pid) { alert('Selecione um produto.'); return; }
    if (!suppMain.value) { alert('Selecione o fornecedor (A).'); return; }

    const tipo = tipoSel.value;
    const precoA = parseFloat(document.getElementById('price_main').value || '0');
    const maxA = getSelectedMax(suppMain);
    if (!priceOk(precoA, maxA)) {
      alert(`Valor (A) inválido ou acima do máximo (R$ ${maxA.toFixed(2)}).`);
      return;
    }

    // A
    addRow({
      os, tipo, slot: 'A',
      produto: currentProductName(),
      fornecedor: currentSupplierName(suppMain),
      d: buildA(tipo),
      preco: precoA
    });

    // B se par
    const isPar = document.querySelector('input[name="pair_option"]:checked').value === 'par';
    if (isPar) {
      let fornecedor2 = currentSupplierName(suppMain);
      let precoB = precoA;
      let maxB = maxA;
      if (supplierDistinto.checked) {
        if (!suppSecond.value) { alert('Selecione o fornecedor (B).'); return; }
        fornecedor2 = currentSupplierName(suppSecond);
        maxB = getSelectedMax(suppSecond);
        const v = parseFloat(document.getElementById('price_second').value || '0');
        if (!priceOk(v, maxB)) {
          alert(`Valor (B) inválido ou acima do máximo (R$ ${maxB.toFixed(2)}).`);
          return;
        }
        precoB = v;
      }
      addRow({
        os, tipo, slot: 'B',
        produto: currentProductName(),
        fornecedor: fornecedor2,
        d: buildB(tipo),
        preco: precoB
      });
    }
    recomputeTotal();
  });

  document.getElementById('clear_list').addEventListener('click', () => {
    tbody.innerHTML = '';
    recomputeTotal();
  });

  document.getElementById('pedidoForm').addEventListener('submit', () => {
    // submissão normal; backend valida novamente
  });

  // Inicializações
  function init() {
    syncTipo();
    syncPairFields();
    table.style.display = 'none';
    rebuildCodeDatalist();
    disableWheelOnNumberInputs();
  }
  init();
</script>
{% endblock %}
